
---
title: "Analysis of Table MEAN"
author: "f.j.Padt"
date: "Friday, April 03, 2015"
output: pdf_document
---

```{r Initialization, echo=FALSE, result=TRUE}
library(data.table)
library("RODBC", lib.loc="~/R/R-3.1.3/library")

A2R <- odbcConnect("ACCESS2R")
dtMEAN <- as.data.table(sqlFetch(A2R, "RA1C230_MEAN", 
                                 stringsAsFactors = FALSE))
setkey(dtMEAN, "MATNR", "MEINH")

dtMARM <- as.data.table(sqlFetch(A2R, "RA1C230_MARM", 
                                 stringsAsFactors = FALSE))
setkey(dtMARM, "MATNR", "MEINH")

dtMAPPING <- copy(dtMEAN)
# dtMAPPING <- rbind(dtMEAN)

close(A2R)

fECHO    <- FALSE
fRESULTS <- TRUE
```

# Cleansing #

Before the mapping table (MEAN) can be analyzed for the entitiy relationship any 
invalid records need to b excluded. The following assumptions/Checks are made on the 
validity of records:
1. Only the Unit of Measure (UoM) of importance is: ST  
2, No double mappings may exist on the key: MATNR, EAN11, EANTP 

## MEINH ##

The following table shows a count on the Unit of measure (UoM). 

```{r MEINH, echo=fECHO, results=fRESULTS}
(tmp      <- table(dtMAPPING$MEINH))
dtMAPPING <- dtMAPPING[MEINH == "ST", ]
```

As can be seen there are `r sum(tmp) - tmp[which(row.names(tmp) == "ST")] `
other Units of Measure in the table. 
These will be excluded from the further analysis.

## DOUBLE ENTRIES ##

The table below shows the number of double records. These records are duplicates
of a mapping relationship per OPCO.   
Although functional there is no issue these records should not exist.

```{r DOUBLE_ENTRIES, echo=fECHO, results=fRESULTS}
dtMAPPING <- dtMAPPING[, DMET := duplicated(dtMAPPING, 
                                            by = c("MATNR", "EAN11", "EANTP"))]
(tmp <- table(dtMAPPING$DMET))
dtMAPPING <- dtMAPPING[DMET != TRUE]
```

As can be seen in the table above `r nrow(dtMAPPING[DMET == TRUE])` 
double entries exist.  
These will be excluded from further analysis.

## N:1 Relationship ##

The table below show if 1 legacy article is mapped against multiple SAP articles.
This relationship could be valid for Suppliers EAN (HE).
Howerever for other EANTP it should not exist!

```{r RN1, echo=fECHO, results=fRESULTS}
dtMAPPING <- dtMAPPING[, D_ET := duplicated(dtMAPPING, 
                                            by = c("EAN11", "EANTP"))]
(tmp <- table(dtMAPPING[D_ET == TRUE]$EANTP))
# (tmp <- sort(table(dtMAPPING[D_ET == TRUE]$EAN11), decreasing = TRUE))
# example of 5 EAN11
# dtMAPPING[EAN11=="1030000275"]

dtMAPPING <- dtMAPPING[D_ET != TRUE]
```

In total there are `r sum(tmp) - 
sum(table(dtMAPPING[D_ET == TRUE & EANTP == "HE"]$EANTP))` entries which should 
not exist. 
All N:1 relationships will be excluded from further analysis.


## TEXT ##

```{r TEXT, echo=fECHO, results=fRESULTS}
dtMAPPING <- dtMAPPING[, REGEX:= gsub("[0-9]", "", EAN11, ignore.case = TRUE)]
t001 <- table(dtMAPPING$REGEX)
(sort(t001, decreasing = TRUE)[1:15])
```

The number of legacy aticle numbers which are numeric (so without characters) is: 
`r t001[which(row.names(sort(t001, decreasing = TRUE)) == "")]`


## DUPLICATES ##

```{r DUPLICATES, echo=fECHO, results=fRESULTS}
dtMAPPING <- dtMAPPING[, DUPLICATE:= grepl("DUPLICATE", EAN11, ignore.case = TRUE)]
(t00      <- table(dtMAPPING$DUPLICATE))
dtMAPPING <- dtMAPPING[DUPLICATE == FALSE, ]
```

Number of ENA11 with "DUPLICATE": `r t00["TRUE"]`.  
These records will *not* be taken into account in the rest of theh analysis. 

## HPEAN ##

The following table shows a count on EANTP and HPEAN.

```{r HPEAN,echo=fECHO, results=fRESULTS}

(t01      <- table(dtMAPPING$EANTP, ifelse(is.na(dtMAPPING$HPEAN), "-", "X")))
dtMAPPING <- dtMAPPING[EANTP != "HE", ]
```
Note there are `r t01[which(rownames(t01) == "HE"), colnames(t01) == "-"]` 
entries with EANTP = HE but which are not marked as HPEAN  
(is this correct)?

The rest of the analysis will focus on the Z* EANTP by excluding HE.


# Analysis #  
The rest of the analysis will focus on the ST UoM.

```{r 1toN, echo=fECHO, results=fRESULTS}

dtMAPPING <- dtMAPPING[, DM__ := duplicated(dtMAPPING, 
                                            by = c("MATNR")                  )]
dtMAPPING <- dtMAPPING[, DME_ := duplicated(dtMAPPING, 
                                            by = c("MATNR", "EAN11")         )]
dtMAPPING <- dtMAPPING[, DMEN := duplicated(dtMAPPING, 
                                            by = c("MATNR", "EAN11", "EANTP"))]
dtMAPPING <- dtMAPPING[, DM_N := duplicated(dtMAPPING, 
                                            by = c("MATNR", "EANTP")         )]

```

Remaining are `r nrow(dtMAPPING)` records.  
following table gives an initial view on the data

```{r View, echo=fECHO}
head(dtMAPPING , 10)
```


```{r Other, echo=fECHO, results=fRESULTS}

# dtMARM[, TAB:="MARM"]
# dtMEAN[, TAB:="MEAN"]
# 
# dtMAPPING <- dtMEAN[, .(MATNR, EAN11, EANTP, TAB)]
# setnames(dtMAPPING, "EANTP", "NUMTP")
# 
# dtMAPPING <- rbind(dtMAPPING, dtMARM[, .(MATNR, EAN11, NUMTP, TAB)])
# setkey(dtMAPPING, "MATNR", "TAB", "NUMTP")
# dtMAPPING <- dtMAPPING[EAN11!="DUPLICATE",]


# dtMAPPING[, DM__ := duplicated(dtMAPPING, by=c("MATNR"))]
# dtMAPPING[, DME_ := duplicated(dtMAPPING, by=c("MATNR","EAN11"))]
# dtMAPPING[, DMEN := duplicated(dtMAPPING, by=c("MATNR","EAN11","NUMTP" ))]
# dtMAPPING[, DM_N := duplicated(dtMAPPING, by=c("MATNR","NUMTP" ))]
# 
# dtMAPPING[, D001 := sum(DMEN), by=c("MATNR","NUMTP")]
# dtMAPPING[, D002 := sum(DM_N), by=c("MATNR","NUMTP")]
# 
# dtCHK001 <- dtMAPPING[D001  > 0]
# dtCHK002 <- dtMAPPING[D001 == 0 & D002 > 0]
# 
# dtCHK003 <- dtMAPPING[D001 == 0 & D002 > 0 & NUMTP == "HE"]
# 
# dtCHK004 <- dtCHK001[DM__ & DME_ & DMEN & DM_N,]
# dtMAT_Z1 <- dtCHK004[NUMTP == "Z1", ]
# 
# 
# dtCHK006 <- dtGVBNL
# setnames(dtCHK006, "article_number", "EAN11")
# 
# 
# dtMAT_Z1[, D_E_ := duplicated(dtMAT_Z1, by=c("EAN11"))]
# setkey(dtMAT_Z1, "EAN11")
# setkey(dtMAT_Z1, "MATNR", "TAB", "NUMTP")
# dtMAT_Z1 <- dtMAT_Z1[D_E_ != TRUE, ]
# 
# dtCHK007 <- merge(dtCHK006, dtMAT_Z1[,.(EAN11, MATNR)], by="EAN11", all.x=TRUE)
```


