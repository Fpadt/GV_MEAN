
---
title: "Analysis of Table MEAN"
author: "f.j.Padt"
date: "Friday, April 03, 2015"
output: pdf_document
---

```{r Initialization, echo=FALSE}
library(data.table)
library("RODBC", lib.loc="~/R/R-3.1.3/library")

A2R <- odbcConnect("ACCESS2R")
dtMEAN <- as.data.table(sqlFetch(A2R, "RA1C230_MEAN", 
                                 stringsAsFactors = FALSE))
setkey(dtMEAN, "MATNR", "MEINH")

dtMARM <- as.data.table(sqlFetch(A2R, "RA1C230_MARM", 
                                 stringsAsFactors = FALSE))
setkey(dtMARM, "MATNR", "MEINH")

dtMAPPING <- copy(dtMEAN)
# dtMAPPING <- rbind(dtMEAN)

close(A2R)
```

## DUPLICATES ##

```{r DUPLICATES, echo=FALSE, results='markup'}
dtMAPPING <- dtMAPPING[, DUPLICATE:= grepl("DUPLICATE", EAN11, ignore.case = TRUE)]
(t00      <- table(dtMAPPING$DUPLICATE))
dtMAPPING <- dtMAPPING[DUPLICATE == FALSE, ]
```

Number of ENA11 with "DUPLICATE": `r t00["TRUE"]`.  
These records will *not* be taken into account in the rest of theh analysis. 

## HPEAN ##

The following table shows a count on EANTP and HPEAN.

```{r HPEAN,echo=FALSE}

(t01      <- table(dtMAPPING$EANTP, ifelse(is.na(dtMAPPING$HPEAN), "-", "X")))
dtMAPPING <- dtMAPPING[EANTP != "HE", ]
```
Note there are `r t01[which(rownames(t01) == "HE"), colnames(t01) == "-"]` 
entries with EANTP = HE but which are not marked as HPEAN  
(is this correct)?

The rest of the analysis will focus on the Z* EANTP by excluding HE.


## MEINH ##

The following table shows a count on the Unit of measure (UoM). 

```{r MEINH, echo=FALSE, results='markup'}
(t02      <- table(dtMAPPING$MEINH))
dtMAPPING <- dtMAPPING[MEINH == "ST", ]
```

As can be seen not everyhting is ST, is this correct?  

# Analysis #  
The rest of the analysis will focus on the ST UoM.

```{r 1toN, echo=FALSE, results='markup'}

dtMAPPING <- dtMAPPING[, DM__ := duplicated(dtMAPPING, 
                                            by = c("MATNR")                  )]
dtMAPPING <- dtMAPPING[, DME_ := duplicated(dtMAPPING, 
                                            by = c("MATNR", "EAN11")         )]
dtMAPPING <- dtMAPPING[, DMEN := duplicated(dtMAPPING, 
                                            by = c("MATNR", "EAN11", "EANTP"))]
dtMAPPING <- dtMAPPING[, DM_N := duplicated(dtMAPPING, 
                                            by = c("MATNR", "EANTP")         )]

```

Remaining are `r nrow(dtMAPPING)` records.  
following table gives an initial view on the data

```{r View}
head(dtMAPPING , 10)
```


```{r Other, echo=FALSE, results='markup'}

# dtMARM[, TAB:="MARM"]
# dtMEAN[, TAB:="MEAN"]
# 
# dtMAPPING <- dtMEAN[, .(MATNR, EAN11, EANTP, TAB)]
# setnames(dtMAPPING, "EANTP", "NUMTP")
# 
# dtMAPPING <- rbind(dtMAPPING, dtMARM[, .(MATNR, EAN11, NUMTP, TAB)])
# setkey(dtMAPPING, "MATNR", "TAB", "NUMTP")
# dtMAPPING <- dtMAPPING[EAN11!="DUPLICATE",]


# dtMAPPING[, DM__ := duplicated(dtMAPPING, by=c("MATNR"))]
# dtMAPPING[, DME_ := duplicated(dtMAPPING, by=c("MATNR","EAN11"))]
# dtMAPPING[, DMEN := duplicated(dtMAPPING, by=c("MATNR","EAN11","NUMTP" ))]
# dtMAPPING[, DM_N := duplicated(dtMAPPING, by=c("MATNR","NUMTP" ))]
# 
# dtMAPPING[, D001 := sum(DMEN), by=c("MATNR","NUMTP")]
# dtMAPPING[, D002 := sum(DM_N), by=c("MATNR","NUMTP")]
# 
# dtCHK001 <- dtMAPPING[D001  > 0]
# dtCHK002 <- dtMAPPING[D001 == 0 & D002 > 0]
# 
# dtCHK003 <- dtMAPPING[D001 == 0 & D002 > 0 & NUMTP == "HE"]
# 
# dtCHK004 <- dtCHK001[DM__ & DME_ & DMEN & DM_N,]
# dtMAT_Z1 <- dtCHK004[NUMTP == "Z1", ]
# 
# 
# dtCHK006 <- dtGVBNL
# setnames(dtCHK006, "article_number", "EAN11")
# 
# 
# dtMAT_Z1[, D_E_ := duplicated(dtMAT_Z1, by=c("EAN11"))]
# setkey(dtMAT_Z1, "EAN11")
# setkey(dtMAT_Z1, "MATNR", "TAB", "NUMTP")
# dtMAT_Z1 <- dtMAT_Z1[D_E_ != TRUE, ]
# 
# dtCHK007 <- merge(dtCHK006, dtMAT_Z1[,.(EAN11, MATNR)], by="EAN11", all.x=TRUE)
```
